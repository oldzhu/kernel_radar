# 2026-01-25 — f8850bc3986562f79619 — 日志分析 + KVM 加速准备

[English](2026-01-25-f8850bc3986562f79619-kvm-and-log-analysis.md)

## 目标

让本地复现结果更可信：

- 将本地 stall 的关键特征与 syzbot 原始 CrashReport/CrashLog 对齐对比。
- 通过启用 KVM 加速，尽量消除明显的“慢速模拟 / CPU 饥饿”伪影（例如巨大的 hrtimer 延迟）。

## 本地观察到的现象（run1/run4）

我们从本地串口日志中提取了信号最强的行：

- `repro/f8850bc3986562f79619/qemu-serial-run1.log`
  - `hrtimer: interrupt took 87634924810 ns` (~87s)
  - `rcu: INFO: rcu_preempt detected stalls on CPUs/tasks:`
  - `rcu_preempt kthread starved for 10502 jiffies`
  - `Kernel panic - not syncing: softlockup: hung tasks`

- `repro/f8850bc3986562f79619/qemu-serial-run4.log`
  - `hrtimer: interrupt took 56068926360 ns` (~56s)
  - `rcu: INFO: rcu_preempt detected stalls on CPUs/tasks:`
  - `rcu_preempt kthread starved for 4893 jiffies`
  - `Kernel panic - not syncing: softlockup: hung tasks`

解读：

- 如此巨大的 hrtimer 中断延迟，说明 guest 并没有持续地获得 CPU 时间。
- 即便不存在“真实 bug”，这种 CPU 饥饿/调度不充分也可能触发看起来像 RCU 饥饿 / watchdog softlockup 的症状。

## syzbot 报告了什么（原始 crash report）

我们检查了 `repro/f8850bc3986562f79619/meta.txt` 里保存的 syzbot CrashReport/CrashLog URL：

- CrashReport: `https://syzkaller.appspot.com/text?tag=CrashReport&x=16f4f642580000`
- CrashLog: `https://syzkaller.appspot.com/text?tag=CrashLog&x=17d98762580000`

关键点：

- syzbot 报告的 call trace 包含 `br_handle_frame`，位于 bridge/netfilter 的转发路径。

因此标题 `INFO: rcu detected stall in br_handle_frame (6)` 与原始报告一致。

## 目前的根因假设（当日）

当前我们面临 **两个重叠的问题**：

1) syzbot 观察到的“真实”问题发生在 bridge/netfilter 路径（涉及 `br_handle_frame`）。
2) 我们本地环境很可能引入了 **CPU 饥饿 / 时钟跳变** 之类的伪影，表现为巨大的 `hrtimer: interrupt took ... ns`；即使没有走到同一条代码路径，也可能诱发 RCU/watchdog 的失败。

因此，优先启用 KVM 来区分 (1) 与 (2)。

## 工具改进：runner 支持可选 KVM

我们更新了生成的 runner 脚本，使其支持可选 KVM 加速：

- 在 `repro/<extid>/run_qemu.sh`：
  - `ENABLE_KVM=1` 启用 `-enable-kvm`（需要 `/dev/kvm`）
  - `CPU=host` 可选传入 `-cpu host`

该变更已提交并推送：

- commit: `d5404a8` (tools: add optional KVM accel to QEMU runner)

文档也已更新：

- `docs/tools-index.md` 现在提到了这些环境变量。

## 主机状态：存在 /dev/kvm，但当前用户缺少权限

- `/dev/kvm` 存在，且属于 `kvm` 组（`crw-rw---- root:kvm`）。
- 当前用户 `oldzhu` **尚未加入** `kvm` 组。

下一步（需要 sudo）：

```bash
sudo usermod -aG kvm oldzhu
# then log out/in (or restart WSL) so group membership refreshes
```

## 下一步

当用户启用 KVM 权限后：

1) 使用加速启动：

```bash
cd repro/f8850bc3986562f79619
ENABLE_KVM=1 CPU=host SMP=2 MEM=4096 DAEMONIZE=1 ./run_qemu.sh
```

2) 重新运行 ReproC。
3) 重新检查串口日志：

- `hrtimer: interrupt took ...` 这类巨大延迟是否消失
- stall 的 call trace 是否包含 `br_handle_frame`（与 syzbot 一致）
